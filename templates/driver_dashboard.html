<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; }
        
        /* Header */
        .header { background: #2563eb; color: white; padding: 15px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 18px; }
        .btn-logout { background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }

        /* Container */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }

        /* Job Card */
        .job-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .job-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .job-id { font-weight: bold; color: #2563eb; }
        .job-date { color: #666; font-size: 14px; }

        /* Timeline Steps */
        .step-item { display: flex; align-items: center; margin-bottom: 10px; }
        .step-icon { width: 25px; height: 25px; border-radius: 50%; background: #eee; margin-right: 10px; display: flex; justify-content: center; align-items: center; font-size: 12px; color: #999; }
        .step-item.done .step-icon { background: #10b981; color: white; } /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à */
        .step-item.active .step-icon { background: #f59e0b; color: white; border: 2px solid #fcd34d; } /* ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß */
        .step-text { font-size: 14px; color: #333; }
        .step-item.done .step-text { color: #10b981; text-decoration: line-through; }

        /* Big Action Button */
        .btn-action { width: 100%; padding: 15px; background-color: #2563eb; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-action:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-action.loading { opacity: 0.7; }

        .no-jobs { text-align: center; color: #999; margin-top: 50px; }
    </style>
</head>
<body>

    <div class="header">
        <h1 id="driverName">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö: ...</h1>
        <button class="btn-logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="container" id="jobList">
        <div class="no-jobs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô...</div>
    </div>

    <script>
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Login ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        const driverData = JSON.parse(localStorage.getItem('driver_data'));
        if (!driverData) { window.location.href = '/'; }
        document.getElementById('driverName').innerText = "‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö: " + driverData.full_name;

        // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        loadJobs();

        async function loadJobs() {
            try {
                const res = await fetch(`/api/driver/jobs?driver_id=${driverData.id}`);
                const data = await res.json();
                const container = document.getElementById('jobList');
                container.innerHTML = '';

                if (data.jobs.length === 0) {
                    container.innerHTML = '<div class="no-jobs">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ üò¥</div>';
                    return;
                }

                data.jobs.forEach(job => {
                    container.appendChild(createJobCard(job));
                });
            } catch (err) {
                console.error(err);
                alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        function createJobCard(job) {
            const card = document.createElement('div');
            card.className = 'job-card';

            // ‡πÅ‡∏õ‡∏•‡∏á JSON String ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Object
            let waypoints = [];
            try { waypoints = JSON.parse(job.waypoints_json); } catch(e) {}
            
            let currentStepIndex = parseInt(job.current_step) || 0;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î (Timeline)
            let timelineHtml = '';
            waypoints.forEach((wp, index) => {
                let statusClass = '';
                if (index < currentStepIndex) statusClass = 'done'; // ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                else if (index === currentStepIndex) statusClass = 'active'; // ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß

                timelineHtml += `
                    <div class="step-item ${statusClass}">
                        <div class="step-icon">${index + 1}</div>
                        <div class="step-text">${wp.name}</div>
                    </div>
                `;
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Action
            let buttonHtml = '';
            if (currentStepIndex < waypoints.length) {
                const nextLocation = waypoints[currentStepIndex].name;
                buttonHtml = `<button class="btn-action" onclick="updateJob('${job.job_id}', ${currentStepIndex}, this)">
                    üìç ‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${currentStepIndex + 1}: ${nextLocation}
                </button>`;
            } else {
                buttonHtml = `<button class="btn-action" style="background:#10b981" disabled>üèÅ ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>`;
            }

            card.innerHTML = `
                <div class="job-header">
                    <span class="job-id">#${job.job_id}</span>
                    <span class="job-date">${job.job_date}</span>
                </div>
                <div style="margin-bottom:10px; font-weight:bold; font-size:18px;">${job.job_name}</div>
                <div class="timeline">${timelineHtml}</div>
                ${buttonHtml}
            `;
            return card;
        }

        function updateJob(jobId, stepIndex, btn) {
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß?")) return;

            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
            btn.classList.add('loading');
            btn.disabled = true;

            // ‡∏î‡∏∂‡∏á GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const long = position.coords.longitude;
                    
                    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
                    await sendUpdate(jobId, stepIndex, lat, long);
                    loadJobs(); // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                }, () => {
                    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î GPS");
                    btn.innerText = "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
                    btn.disabled = false;
                });
            } else {
                alert("Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
            }
        }

        async function sendUpdate(jobId, stepIndex, lat, long) {
            await fetch('/api/job/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    job_id: jobId,
                    step_index: stepIndex + 1, // ‡∏Ç‡∏¢‡∏±‡∏ö‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    lat: lat,
                    long: long
                })
            });
        }

        function logout() {
            localStorage.removeItem('driver_data');
            window.location.href = '/';
        }
    </script>
</body>
</html>