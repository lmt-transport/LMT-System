<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMT. Driver</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... (CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Kanit', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding-bottom: 80px; color:#2d3748; }
        .bg-decoration { position: fixed; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none; }
        .particle { position: absolute; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        
        /* Header */
        .header { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding: 15px 20px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .brand-area { display: flex; align-items: center; gap: 12px; }
        .logo-img { height: 50px; width: 50px; background: white; border-radius: 50%; padding: 3px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); object-fit: contain; }
        .driver-info { font-size: 11px; color: rgba(255,255,255,0.9); text-transform: uppercase; }
        .driver-name { font-size: 16px; font-weight: 600; color: white; }
        .btn-logout { background: rgba(255, 87, 87, 0.9); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 14px; border-radius: 12px; cursor: pointer; font-family: 'Kanit'; font-size: 12px; transition: 0.3s; }

        /* Tabs */
        .tabs-container { display: flex; justify-content: center; gap: 15px; margin: 20px 0 10px 0; position: relative; z-index: 10; }
        .tab-btn { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.1); padding: 8px 24px; border-radius: 25px; font-family: 'Kanit'; font-size: 14px; cursor: pointer; transition: 0.3s; backdrop-filter: blur(5px); }
        .tab-btn.active { background: white; color: #667eea; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transform: scale(1.05); }

        /* Container */
        .container { padding: 10px 15px; max-width: 600px; margin: 0 auto; position: relative; z-index: 1; }
        .hidden { display: none; }

        /* Job Card */
        .job-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .job-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 12px; }
        .job-id { background: linear-gradient(135deg, #667eea20, #764ba220); color: #667eea; padding: 4px 10px; border-radius: 8px; font-weight: 600; font-size: 14px; }
        .job-status { font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 600; text-transform: uppercase; }
        .status-pending { background: #fff7ed; color: #c2410c; }
        .status-active { background: #e0f2fe; color: #0369a1; }
        .status-completed { background: #f0fdf4; color: #15803d; }

        .job-title { font-size: 18px; font-weight: 600; color: #2d3748; margin-bottom: 10px; }

        /* [NEW] Appointment Time Style */
        .job-schedule {
            background: #fdf2f8; border-left: 4px solid #db2777;
            padding: 10px; border-radius: 8px; margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px;
        }
        .schedule-icon { font-size: 18px; }
        .schedule-label { font-size: 12px; color: #9d174d; font-weight: 500; display: block; }
        .schedule-time { font-size: 15px; color: #be185d; font-weight: 600; }

        /* Timeline */
        .timeline { margin-bottom: 24px; position: relative; padding: 5px 0; }
        .timeline::before { content:''; position:absolute; left:15px; top:15px; bottom:15px; width:3px; background: linear-gradient(to bottom, #e2e8f0, #cbd5e0); border-radius:2px; z-index:0; }
        .step-item { display: flex; align-items: flex-start; margin-bottom: 20px; position: relative; z-index: 1; }
        .step-icon { width:32px; height:32px; background:white; border:3px solid #e2e8f0; border-radius:50%; display:flex; justify-content:center; align-items:center; margin-right:15px; font-size:13px; color:#a0aec0; font-weight:bold; flex-shrink:0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .step-content { flex: 1; padding-top: 2px; }
        .step-label { font-size: 11px; color: #a0aec0; font-weight: 500; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .step-text { font-size: 15px; color: #4a5568; font-weight: 500; line-height: 1.5; }
        
        .step-item.active .step-icon { background: #fff; border-color: #f59e0b; color: #f59e0b; box-shadow: 0 0 0 4px rgba(246, 173, 85, 0.2); }
        .step-item.active .step-label { color: #ed8936; font-weight: 600; }
        .step-item.done .step-icon { background: #10b981; border-color: #10b981; color: white; }

        /* Buttons */
        .btn-action { width: 100%; padding: 16px; border: none; border-radius: 16px; font-size: 16px; font-family: 'Kanit'; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; position: relative; overflow: hidden; }
        .btn-accept { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; box-shadow: 0 8px 20px rgba(234, 88, 12, 0.3); animation: pulse 2s infinite; }
        .btn-update { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); }
        .btn-action.loading { opacity: 0.8; pointer-events: none; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }

        .no-jobs { text-align: center; color: white; margin-top: 80px; }
        .spinner { width: 35px; height: 35px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="bg-decoration">
        <div class="particle" style="width:60px; height:60px; top:10%; left:10%;"></div>
        <div class="particle" style="width:40px; height:40px; top:50%; left:80%;"></div>
        <div class="particle" style="width:80px; height:80px; top:80%; left:20%;"></div>
    </div>

    <div class="header">
        <div class="brand-area">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo-img">
            <div class="driver-info-wrapper">
                <div class="driver-info">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</div>
                <div class="driver-name" id="driverName">...</div>
            </div>
        </div>
        <button class="btn-logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('active')">‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
        <button class="tab-btn" onclick="switchTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</button>
    </div>

    <div class="container" id="activeContainer">
        <div class="no-jobs"><div class="spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
    <div class="container hidden" id="historyContainer">
        <div class="no-jobs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>
    </div>

    <script>
        const driverData = JSON.parse(localStorage.getItem('driver_data'));
        if (!driverData || driverData.role === 'admin') { window.location.href = '/'; }
        document.getElementById('driverName').innerText = driverData.full_name;

        let allJobs = [];
        loadJobs();

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if (tab === 'active') {
                document.getElementById('activeContainer').classList.remove('hidden');
                document.getElementById('historyContainer').classList.add('hidden');
            } else {
                document.getElementById('activeContainer').classList.add('hidden');
                document.getElementById('historyContainer').classList.remove('hidden');
            }
        }

        async function loadJobs() {
            try {
                const res = await fetch(`/api/driver/jobs?driver_id=${driverData.id}`);
                const data = await res.json();
                allJobs = data.jobs;
                renderJobs();
            } catch (err) { document.getElementById('activeContainer').innerHTML = '<div class="no-jobs">‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>'; }
        }

        function renderJobs() {
            const activeDiv = document.getElementById('activeContainer');
            const historyDiv = document.getElementById('historyContainer');
            activeDiv.innerHTML = ''; historyDiv.innerHTML = '';

            const activeJobs = [];
            const historyJobs = [];

            allJobs.forEach(job => {
                let isFinished = false;
                try {
                    const wps = JSON.parse(job.waypoints_json);
                    const step = parseInt(job.current_step) || 0;
                    if (step >= wps.length) isFinished = true;
                } catch(e) {}

                if (job.status === 'Completed' || isFinished) historyJobs.push(job);
                else activeJobs.push(job);
            });

            if (activeJobs.length === 0) activeDiv.innerHTML = '<div class="no-jobs"><span style="font-size:50px">üõå</span><br>‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö</div>';
            else activeJobs.forEach(job => activeDiv.appendChild(createJobCard(job, false)));

            if (historyJobs.length === 0) historyDiv.innerHTML = '<div class="no-jobs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>';
            else historyJobs.forEach(job => historyDiv.appendChild(createJobCard(job, true)));
        }

        function createJobCard(job, isHistory) {
            const card = document.createElement('div');
            card.className = 'job-card';

            let waypoints = [];
            try { waypoints = JSON.parse(job.waypoints_json); } catch(e) {}
            let currentStepIndex = parseInt(job.current_step) || 0;

            // [NEW] Format Appointment Time
            let pickupDateStr = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            if (job.pickup_time) {
                const d = new Date(job.pickup_time);
                pickupDateStr = d.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' });
            }

            // Status Badge
            let statusBadge = '';
            if (isHistory) statusBadge = '<span class="job-status status-completed">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>';
            else if (job.status === 'Pending') statusBadge = '<span class="job-status status-pending">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</span>';
            else statusBadge = '<span class="job-status status-active">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';

            // Timeline
            let timelineHtml = '';
            waypoints.forEach((wp, index) => {
                let statusClass = '';
                let iconText = index + 1;
                if (isHistory) { statusClass = 'done'; iconText = '‚úì'; }
                else if (job.status === 'Active') {
                    if (index < currentStepIndex) { statusClass = 'done'; iconText = '‚úì'; }
                    else if (index === currentStepIndex) { statusClass = 'active'; }
                }
                const typeIcon = wp.type === 'pickup' ? 'üì¶' : 'üìç';
                const typeLabel = wp.type === 'pickup' ? '‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';

                timelineHtml += `
                    <div class="step-item ${statusClass}">
                        <div class="step-icon">${iconText}</div>
                        <div class="step-content">
                            <span class="step-label">${typeIcon} ${typeLabel}</span>
                            <div class="step-text">${wp.name}</div>
                        </div>
                    </div>`;
            });

            // Actions
            let actionHtml = '';
            if (isHistory) {
                actionHtml = `<div style="text-align:center; font-size:13px; color:#10b981; font-weight:500; margin-top:10px;">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${job.last_update}</div>`;
            } 
            else if (job.status === 'Pending') {
                actionHtml = `<button class="btn-action btn-accept" onclick="acceptJob('${job.job_id}')">‚úÖ ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>`;
            } 
            else if (job.status === 'Active') {
                if (currentStepIndex < waypoints.length) {
                    const nextName = waypoints[currentStepIndex].name;
                    const typeLabel = waypoints[currentStepIndex].type === 'pickup' ? '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö' : '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á';
                    const icon = waypoints[currentStepIndex].type === 'pickup' ? 'üì¶' : 'üìç';
                    actionHtml = `
                        <button class="btn-action btn-update" onclick="updateJob('${job.job_id}', ${currentStepIndex}, this)">${icon} ${typeLabel}: ${nextName}</button>
                        <div style="text-align:center; font-size:12px; color:#999; margin-top:5px;">(‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏ñ‡∏à‡∏≠‡∏î‡∏™‡∏ô‡∏¥‡∏ó)</div>`;
                }
            }

            // [NEW] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (job-schedule)
            card.innerHTML = `
                <div class="job-header"><span class="job-id">${job.job_id}</span>${statusBadge}</div>
                <div class="job-title">${job.job_name}</div>
                
                <div class="job-schedule">
                    <div class="schedule-icon">üìÖ</div>
                    <div>
                        <span class="schedule-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                        <div class="schedule-time">${pickupDateStr}</div>
                    </div>
                </div>

                ${job.status === 'Pending' ? '' : `<div class="timeline">${timelineHtml}</div>`}
                ${actionHtml}
            `;
            return card;
        }

        async function acceptJob(jobId) {
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) return;
            try {
                const res = await fetch('/api/job/accept', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ job_id: jobId }) });
                if ((await res.json()).status === 'success') { alert("‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); loadJobs(); }
            } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
        }

        async function updateJob(jobId, stepIndex, btn) {
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?")) return;
            const originalText = btn.innerText;
            btn.innerText = "üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö GPS...";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    btn.innerText = "üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                    try {
                        await fetch('/api/job/update', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ job_id: jobId, step_index: stepIndex + 1, lat: pos.coords.latitude, long: pos.coords.longitude })
                        });
                        btn.innerText = "‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
                        setTimeout(() => loadJobs(), 800);
                    } catch(e) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); btn.innerText = originalText; }
                }, () => { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS"); btn.innerText = originalText; });
            } else { alert("‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS"); btn.innerText = originalText; }
        }

        function logout() { if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) { localStorage.removeItem('driver_data'); window.location.href = '/'; } }
    </script>
</body>
</html>