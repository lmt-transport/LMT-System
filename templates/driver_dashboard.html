<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMT Driver - ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô --- */
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f3f4f6; 
            margin: 0; 
            padding: 0; 
            padding-bottom: 50px; /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        }
        
        /* --- Header (‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏¥‡∏î‡∏´‡∏ô‡∏∂‡∏ö) --- */
        .header { 
            background: #2563eb; 
            color: white; 
            padding: 15px 20px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .brand-area { display: flex; align-items: center; gap: 10px; }
        .logo-img { height: 32px; width: auto; background: white; border-radius: 4px; padding: 2px; }
        .driver-info { font-size: 14px; font-weight: 300; }
        .driver-name { font-size: 16px; font-weight: 600; }
        
        .btn-logout { 
            background: rgba(255,255,255,0.2); 
            border: 1px solid rgba(255,255,255,0.5); 
            color: white; 
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-family: 'Kanit';
            font-size: 12px;
        }

        /* --- Container & Cards --- */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }

        .job-card { 
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            border: 1px solid #e5e7eb;
        }
        
        .job-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 10px; 
        }
        .job-id { font-weight: bold; color: #2563eb; background: #eff6ff; padding: 2px 8px; border-radius: 4px; font-size: 14px; }
        .job-date { color: #6b7280; font-size: 14px; }

        .job-title { font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 15px; }

        /* --- Timeline (‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤) --- */
        .timeline { margin-bottom: 20px; position: relative; }
        /* ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
        .timeline::before {
            content: ''; position: absolute; left: 14px; top: 10px; bottom: 10px;
            width: 2px; background: #e5e7eb; z-index: 0;
        }
        
        .step-item { display: flex; align-items: center; margin-bottom: 15px; position: relative; z-index: 1; }
        
        .step-icon { 
            width: 30px; height: 30px; 
            border-radius: 50%; 
            background: white; 
            border: 2px solid #d1d5db; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 12px; color: #9ca3af; margin-right: 12px; 
            font-weight: bold;
        }
        
        .step-text { font-size: 15px; color: #4b5563; flex: 1; }

        /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) */
        .step-item.done .step-icon { background: #10b981; border-color: #10b981; color: white; }
        .step-item.done .step-text { text-decoration: line-through; color: #9ca3af; }
        
        /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ (‡∏™‡πâ‡∏°) */
        .step-item.active .step-icon { background: #f59e0b; border-color: #f59e0b; color: white; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
        .step-item.active .step-text { font-weight: 600; color: #1f2937; font-size: 16px; }

        /* --- Big Action Button --- */
        .btn-action { 
            width: 100%; 
            padding: 16px; 
            background-color: #2563eb; 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 18px; 
            font-family: 'Kanit', sans-serif;
            font-weight: 600; 
            cursor: pointer; 
            display: flex; justify-content: center; align-items: center; gap: 8px;
            transition: background 0.2s;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }
        .btn-action:active { transform: scale(0.98); }
        .btn-action:disabled { background-color: #9ca3af; cursor: not-allowed; box-shadow: none; }
        .btn-action.completed { background-color: #059669; cursor: default; }
        
        /* Loading State */
        .btn-action.loading { opacity: 0.7; pointer-events: none; }

        .no-jobs { text-align: center; color: #9ca3af; margin-top: 60px; }
        .no-jobs-icon { font-size: 48px; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand-area">
            <img src="/static/logo.png" alt="Logo" class="logo-img">
            <div>
                <div class="driver-info">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</div>
                <div class="driver-name" id="driverName">...</div>
            </div>
        </div>
        <button class="btn-logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="container" id="jobList">
        <div class="no-jobs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô...</div>
    </div>

    <script>
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Login
        const driverData = JSON.parse(localStorage.getItem('driver_data'));
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login
        if (!driverData || driverData.role === 'admin') { 
            window.location.href = '/'; 
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
        document.getElementById('driverName').innerText = driverData.full_name;

        // 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô
        loadJobs();

        async function loadJobs() {
            try {
                const res = await fetch(`/api/driver/jobs?driver_id=${driverData.id}`);
                const data = await res.json();
                const container = document.getElementById('jobList');
                container.innerHTML = '';

                if (data.jobs.length === 0) {
                    container.innerHTML = `
                        <div class="no-jobs">
                            <span class="no-jobs-icon">üõå</span>
                            ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö<br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                        </div>`;
                    return;
                }

                data.jobs.forEach(job => {
                    container.appendChild(createJobCard(job));
                });
            } catch (err) {
                console.error(err);
                document.getElementById('jobList').innerHTML = '<div class="no-jobs" style="color:red">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</div>';
            }
        }

        function createJobCard(job) {
            const card = document.createElement('div');
            card.className = 'job-card';

            // ‡πÅ‡∏õ‡∏•‡∏á JSON Waypoints
            let waypoints = [];
            try { waypoints = JSON.parse(job.waypoints_json); } catch(e) {}
            
            let currentStepIndex = parseInt(job.current_step) || 0;

            // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á Timeline HTML ---
            let timelineHtml = '';
            waypoints.forEach((wp, index) => {
                let statusClass = '';
                let iconText = index + 1;
                let iconEmoji = wp.type === 'pickup' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                
                if (index < currentStepIndex) {
                    statusClass = 'done';
                    iconText = '‚úì'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å
                } else if (index === currentStepIndex) {
                    statusClass = 'active';
                }

                timelineHtml += `
                    <div class="step-item ${statusClass}">
                        <div class="step-icon">${iconText}</div>
                        <div class="step-text">
                            <span style="font-size:12px; color:#999;">${wp.type==='pickup'?'‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤':'‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}</span><br>
                            ${wp.name}
                        </div>
                    </div>
                `;
            });

            // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Action Button ---
            let buttonHtml = '';
            if (currentStepIndex < waypoints.length) {
                // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏á‡∏≤‡∏ô: ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                const nextLocation = waypoints[currentStepIndex].name;
                const typeLabel = waypoints[currentStepIndex].type === 'pickup' ? '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö' : '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á';
                
                buttonHtml = `
                    <button class="btn-action" onclick="updateJob('${job.job_id}', ${currentStepIndex}, this)">
                        üìç ${typeLabel}: ${nextLocation}
                    </button>
                    <div style="text-align:center; margin-top:5px; font-size:12px; color:#666;">
                        (‡∏Å‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏ñ‡∏à‡∏≠‡∏î‡∏™‡∏ô‡∏¥‡∏ó‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
                    </div>
                `;
            } else {
                // ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                buttonHtml = `
                    <button class="btn-action completed" disabled>
                        üèÅ ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß
                    </button>
                `;
            }

            card.innerHTML = `
                <div class="job-header">
                    <span class="job-id">${job.job_id}</span>
                    <span class="job-date">${job.job_date}</span>
                </div>
                <div class="job-title">${job.job_name}</div>
                <div class="timeline">${timelineHtml}</div>
                ${buttonHtml}
            `;
            return card;
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô ---
        function updateJob(jobId, stepIndex, btn) {
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?")) return;

            // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô Loading
            const originalText = btn.innerText;
            btn.innerText = "üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS...";
            btn.classList.add('loading');

            // 2. ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    // Success Callback
                    async (position) => {
                        const lat = position.coords.latitude;
                        const long = position.coords.longitude;
                        
                        btn.innerText = "üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                        
                        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Server
                        await sendUpdate(jobId, stepIndex, lat, long, btn, originalText);
                    }, 
                    // Error Callback
                    (error) => {
                        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
                        console.error(error);
                        resetButton(btn, originalText);
                    },
                    // Options
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                alert("Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
                resetButton(btn, originalText);
            }
        }

        async function sendUpdate(jobId, stepIndex, lat, long, btn, originalText) {
            try {
                const response = await fetch('/api/job/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: jobId,
                        step_index: stepIndex + 1, // ‡∏Ç‡∏¢‡∏±‡∏ö‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                        lat: lat,
                        long: long
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Timeline
                    loadJobs(); 
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + error.message);
                resetButton(btn, originalText);
            }
        }

        function resetButton(btn, text) {
            btn.innerText = text;
            btn.classList.remove('loading');
        }

        function logout() {
            if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) {
                localStorage.removeItem('driver_data');
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>