<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMT. Driver - ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { 
            font-family: 'Kanit', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* --- Background Decoration --- */
        .bg-decoration { position: fixed; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none; }
        .particle { position: absolute; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 6s ease-in-out infinite; }
        @keyframes float { 
            0%, 100% { transform: translateY(0px) rotate(0deg); } 
            50% { transform: translateY(-20px) rotate(180deg); } 
        }
        
        /* --- Header --- */
        .header { 
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: white; padding: 15px 20px;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            animation: slideDown 0.5s ease-out;
        }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .brand-area { display: flex; align-items: center; gap: 12px; animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .logo-img { 
            height: 50px; width: 50px; background: white; 
            border-radius: 50%; padding: 3px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            object-fit: contain; transition: transform 0.3s ease;
        }
        .logo-img:hover { transform: scale(1.1) rotate(5deg); }
        
        .driver-info-wrapper { display: flex; flex-direction: column; gap: 2px; }
        .driver-info { font-size: 12px; font-weight: 300; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        .driver-name { font-size: 18px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .btn-logout { 
            background: rgba(255, 87, 87, 0.9); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 8px 16px; border-radius: 12px; 
            cursor: pointer; font-family: 'Kanit'; font-size: 13px; font-weight: 500;
            transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(255, 87, 87, 0.3);
        }
        .btn-logout:hover { background: rgba(255, 87, 87, 1); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 87, 87, 0.4); }

        /* --- Tabs Menu (Custom Glass Style) --- */
        .tabs-container {
            display: flex; justify-content: center; gap: 15px;
            margin: 20px 0 10px 0; position: relative; z-index: 10;
            animation: fadeIn 1s ease-out;
        }
        .tab-btn {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 25px; border-radius: 30px;
            font-family: 'Kanit'; font-size: 14px; cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background: white; color: #667eea; font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transform: scale(1.05);
        }

        /* --- Container & Cards --- */
        .container { padding: 10px 15px; max-width: 700px; margin: 0 auto; position: relative; z-index: 1; }
        .hidden { display: none; }

        .job-card { 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 24px; padding: 24px; margin-bottom: 24px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s ease; animation: cardSlideIn 0.5s ease-out; animation-fill-mode: both;
        }
        @keyframes cardSlideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .job-card:hover { transform: translateY(-5px); box-shadow: 0 15px 50px rgba(0,0,0,0.2); }

        .job-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid #f0f0f0; }
        .job-id { 
            font-weight: 600; color: #667eea; 
            background: linear-gradient(135deg, #667eea20, #764ba220);
            padding: 6px 14px; border-radius: 12px; font-size: 14px;
            border: 1px solid #667eea30; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        /* Status Badges */
        .job-status { font-size: 12px; padding: 4px 10px; border-radius: 8px; font-weight: 600; }
        .status-pending { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .status-active { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .status-completed { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }

        .job-title { font-size: 20px; font-weight: 600; color: #2D3748; margin-bottom: 20px; line-height: 1.4; }

        /* --- Timeline --- */
        .timeline { margin-bottom: 24px; position: relative; padding: 10px 0; }
        .timeline::before { 
            content: ''; position: absolute; left: 14px; top: 20px; bottom: 20px; width: 3px; 
            background: linear-gradient(to bottom, #e2e8f0, #cbd5e0); border-radius: 2px; z-index: 0;
        }
        
        .step-item { display: flex; align-items: flex-start; margin-bottom: 20px; position: relative; z-index: 1; transition: all 0.3s ease; }
        .step-item:last-child { margin-bottom: 0; }
        
        .step-icon { 
            width: 32px; height: 32px; border-radius: 50%; background: white; 
            border: 3px solid #e2e8f0; display: flex; justify-content: center; align-items: center; 
            font-size: 13px; color: #a0aec0; margin-right: 16px; font-weight: bold; flex-shrink: 0;
            transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .step-content { flex: 1; padding-top: 2px; }
        .step-label { font-size: 11px; color: #a0aec0; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
        .step-text { font-size: 15px; color: #4a5568; font-weight: 500; line-height: 1.5; }

        /* Step States */
        .step-item.active .step-icon { 
            background: linear-gradient(135deg, #f6ad55, #ed8936); border-color: #f6ad55; color: white;
            box-shadow: 0 0 0 4px rgba(246, 173, 85, 0.2); animation: pulse 2s ease-in-out infinite;
        }
        .step-item.active .step-text, .step-item.active .step-label { color: #2D3748; font-weight: 600; }
        .step-item.active .step-label { color: #ed8936; }

        .step-item.done .step-icon { background: linear-gradient(135deg, #48bb78, #38a169); border-color: #48bb78; color: white; }
        .step-item.done .step-text, .step-item.done .step-label { text-decoration: line-through; color: #a0aec0; }

        /* --- Buttons --- */
        .btn-action { 
            width: 100%; padding: 16px 24px; border: none; border-radius: 16px; 
            font-size: 17px; font-family: 'Kanit', sans-serif; font-weight: 600; 
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px;
            transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .btn-action:hover { transform: translateY(-2px); }
        .btn-action:active { transform: translateY(0); }
        .btn-action.loading { opacity: 0.8; pointer-events: none; animation: btnPulse 1.5s ease-in-out infinite; }
        
        /* Button Variants */
        .btn-update { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-accept {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white;
            box-shadow: 0 8px 20px rgba(234, 88, 12, 0.4); animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        @keyframes btnPulse { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; } }

        .btn-hint { text-align: center; margin-top: 8px; font-size: 12px; color: #718096; display: flex; justify-content: center; gap: 4px; }
        .btn-hint::before { content: "‚ÑπÔ∏è"; font-size: 13px; }

        /* No Jobs & Error */
        .no-jobs { text-align: center; color: white; margin-top: 80px; animation: fadeIn 1s ease-out; }
        .no-jobs-icon { font-size: 64px; margin-bottom: 16px; display: block; animation: float 3s ease-in-out infinite; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { background: rgba(255, 87, 87, 0.9); color: white; padding: 16px; border-radius: 12px; margin: 20px; text-align: center; }

        /* Stagger Animation */
        .job-card:nth-child(1) { animation-delay: 0.1s; }
        .job-card:nth-child(2) { animation-delay: 0.2s; }
        .job-card:nth-child(3) { animation-delay: 0.3s; }
    </style>
</head>
<body>
    <div class="bg-decoration">
        <div class="particle" style="width: 60px; height: 60px; top: 10%; left: 10%; animation-delay: 0s;"></div>
        <div class="particle" style="width: 40px; height: 40px; top: 60%; left: 80%; animation-delay: 2s;"></div>
        <div class="particle" style="width: 80px; height: 80px; top: 80%; left: 20%; animation-delay: 4s;"></div>
    </div>

    <div class="header">
        <div class="brand-area">
            <img src="https://i.postimg.cc/cL8k32CT/logo.png" alt="Logo" class="logo-img">
            <div class="driver-info-wrapper">
                <div class="driver-info">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</div>
                <div class="driver-name" id="driverName">...</div>
            </div>
        </div>
        <button class="btn-logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('active')">‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
        <button class="tab-btn" onclick="switchTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</button>
    </div>

    <div class="container" id="activeContainer">
        <div class="no-jobs">
            <div class="spinner"></div>
            <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô...</div>
        </div>
    </div>

    <div class="container hidden" id="historyContainer">
        <div class="no-jobs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>
    </div>

    <script>
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Login
        const driverData = JSON.parse(localStorage.getItem('driver_data'));
        if (!driverData || driverData.role === 'admin') { 
            window.location.href = '/'; 
        }
        document.getElementById('driverName').innerText = driverData.full_name;

        let allJobs = [];
        loadJobs();

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö Tab
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'active') {
                document.getElementById('activeContainer').classList.remove('hidden');
                document.getElementById('historyContainer').classList.add('hidden');
            } else {
                document.getElementById('activeContainer').classList.add('hidden');
                document.getElementById('historyContainer').classList.remove('hidden');
            }
        }

        // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô
        async function loadJobs() {
            try {
                const res = await fetch(`/api/driver/jobs?driver_id=${driverData.id}`);
                const data = await res.json();
                allJobs = data.jobs;
                renderJobs();
            } catch (err) {
                console.error(err);
                document.getElementById('activeContainer').innerHTML = 
                    '<div class="error-message">‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ<br>‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</div>';
            }
        }

        // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô (Render)
        function renderJobs() {
            const activeDiv = document.getElementById('activeContainer');
            const historyDiv = document.getElementById('historyContainer');
            activeDiv.innerHTML = ''; historyDiv.innerHTML = '';

            // ‡πÅ‡∏¢‡∏Å‡∏á‡∏≤‡∏ô Active ‡∏Å‡∏±‡∏ö History
            const activeJobs = allJobs.filter(j => j.status !== 'Completed');
            const historyJobs = allJobs.filter(j => j.status === 'Completed');

            // Render Active Tab
            if (activeJobs.length === 0) {
                activeDiv.innerHTML = `
                    <div class="no-jobs">
                        <span class="no-jobs-icon">üõå</span>
                        <div style="font-size:20px; font-weight:500;">‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö</div>
                        <div style="opacity:0.8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                    </div>`;
            } else {
                activeJobs.forEach(job => activeDiv.appendChild(createJobCard(job, false)));
            }

            // Render History Tab
            if (historyJobs.length === 0) {
                historyDiv.innerHTML = '<div class="no-jobs">üìú ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>';
            } else {
                historyJobs.forEach(job => historyDiv.appendChild(createJobCard(job, true)));
            }
        }

        // 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏á‡∏≤‡∏ô HTML
        function createJobCard(job, isHistory) {
            const card = document.createElement('div');
            card.className = 'job-card';

            let waypoints = [];
            try { waypoints = JSON.parse(job.waypoints_json); } catch(e) {}
            let currentStepIndex = parseInt(job.current_step) || 0;

            // Determine Status Badge
            let statusBadge = '';
            if (isHistory) statusBadge = '<span class="job-status status-completed">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>';
            else if (job.status === 'Pending') statusBadge = '<span class="job-status status-pending">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</span>';
            else statusBadge = '<span class="job-status status-active">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';

            // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á Timeline HTML ---
            let timelineHtml = '';
            waypoints.forEach((wp, index) => {
                let statusClass = '';
                let iconText = index + 1;
                
                if (isHistory) {
                    statusClass = 'done'; iconText = '‚úì';
                } else if (job.status === 'Active') {
                    if (index < currentStepIndex) { statusClass = 'done'; iconText = '‚úì'; }
                    else if (index === currentStepIndex) { statusClass = 'active'; }
                }
                
                const typeLabel = wp.type === 'pickup' ? '‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                const typeIcon = wp.type === 'pickup' ? 'üì¶' : 'üìç';

                timelineHtml += `
                    <div class="step-item ${statusClass}">
                        <div class="step-icon">${iconText}</div>
                        <div class="step-content">
                            <div class="step-label">${typeIcon} ${typeLabel}</div>
                            <div class="step-text">${wp.name}</div>
                        </div>
                    </div>
                `;
            });

            // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Action ---
            let actionHtml = '';
            if (isHistory) {
                actionHtml = `<div style="text-align:center; color:#10b981; font-weight:500; margin-top:10px;">‚úÖ ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${job.last_update}</div>`;
            } 
            else if (job.status === 'Pending') {
                // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (‡∏™‡πâ‡∏°)
                actionHtml = `
                    <div style="text-align:center; margin-bottom:10px; color:#ea580c; font-size:14px;">üëã ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</div>
                    <button class="btn-action btn-accept" onclick="acceptJob('${job.job_id}')">
                        ‚úÖ ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
                    </button>`;
            } 
            else if (job.status === 'Active') {
                // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏°‡πà‡∏ß‡∏á)
                if (currentStepIndex < waypoints.length) {
                    const nextName = waypoints[currentStepIndex].name;
                    const typeLabel = waypoints[currentStepIndex].type === 'pickup' ? '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö' : '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á';
                    const icon = waypoints[currentStepIndex].type === 'pickup' ? 'üì¶' : 'üìç';
                    
                    actionHtml = `
                        <button class="btn-action btn-update" onclick="updateJob('${job.job_id}', ${currentStepIndex}, this)">
                            ${icon} ${typeLabel}: ${nextName}
                        </button>
                        <div class="btn-hint">‡∏Å‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏ñ‡∏à‡∏≠‡∏î‡∏™‡∏ô‡∏¥‡∏ó‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
                    `;
                }
            }

            card.innerHTML = `
                <div class="job-header">
                    <span class="job-id">${job.job_id}</span>
                    ${statusBadge}
                </div>
                <div class="job-title">${job.job_name}</div>
                ${job.status === 'Pending' ? '' : `<div class="timeline">${timelineHtml}</div>`}
                ${actionHtml}
            `;
            return card;
        }

        // --- API Actions ---

        async function acceptJob(jobId) {
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) return;
            try {
                const res = await fetch('/api/job/accept', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: jobId })
                });
                if ((await res.json()).status === 'success') {
                    alert("‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
                    loadJobs();
                }
            } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô"); }
        }

        async function updateJob(jobId, stepIndex, btn) {
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß?")) return;

            const originalText = btn.innerHTML;
            btn.innerHTML = "üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS...";
            btn.classList.add('loading');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const long = position.coords.longitude;
                        
                        btn.innerHTML = "üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                        await sendUpdate(jobId, stepIndex, lat, long, btn, originalText);
                    }, 
                    (error) => {
                        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ!\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
                        resetButton(btn, originalText);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                alert("‚ùå Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
                resetButton(btn, originalText);
            }
        }

        async function sendUpdate(jobId, stepIndex, lat, long, btn, originalText) {
            try {
                const response = await fetch('/api/job/update', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: jobId, step_index: stepIndex + 1, lat: lat, long: long })
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    btn.innerHTML = "‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
                    setTimeout(() => loadJobs(), 800);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
                resetButton(btn, originalText);
            }
        }

        function resetButton(btn, text) {
            btn.innerHTML = text;
            btn.classList.remove('loading');
        }

        function logout() {
            if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) {
                localStorage.removeItem('driver_data');
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>